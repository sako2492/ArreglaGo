package pe.com.arreglago.controller;

import java.io.File;
import java.io.IOException;
import java.security.Principal;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import jakarta.servlet.http.HttpSession;
import net.coobird.thumbnailator.Thumbnails;

import pe.com.arreglago.entity.UsuarioEntity;
import pe.com.arreglago.entity.ProveedorEntity;
import pe.com.arreglago.entity.ReniecEntity;
import pe.com.arreglago.entity.ResenaEntity;
import pe.com.arreglago.entity.RolEntity;
import pe.com.arreglago.entity.ClienteEntity;
import pe.com.arreglago.entity.ContratacionEntity;
import pe.com.arreglago.service.UsuarioService;
import pe.com.arreglago.service.ProveedorService;
import pe.com.arreglago.service.ReniecService;
import pe.com.arreglago.service.CategoriaService;
import pe.com.arreglago.service.ClienteService;
import pe.com.arreglago.service.DistritoService;
import pe.com.arreglago.service.EmailService;
import pe.com.arreglago.service.TipoDocumentoService;
import pe.com.arreglago.service.ResenaService;
import pe.com.arreglago.service.RolService;
import pe.com.arreglago.service.ContratacionService;

@Controller
@RequestMapping("/profesional")
public class ProfesionalController {

	// ----------------------------------------------------
    // INYECCIONES DE DEPENDENCIAS
    // ----------------------------------------------------
    @Autowired private UsuarioService usuarioService;
    @Autowired private ProveedorService proveedorService;
    @Autowired private CategoriaService categoriaService;
    @Autowired private DistritoService distritoService;
    @Autowired private TipoDocumentoService tipoDocumentoService;
    @Autowired private ResenaService resenaService;
    @Autowired private ContratacionService contratacionService;
    @Autowired private ClienteService clienteService;
    @Autowired private ReniecService reniecService;
	@Autowired private EmailService emailService;
	@Autowired private RolService rolService;
    
    // ====================================================
    // ü•á M√âTODOS DE PERFIL PROPIO (SIN ID) - DEBEN IR PRIMERO
    // ====================================================
    
    @GetMapping("/perfil")
    public String verMiPerfil(Principal principal, Model model) {
        
        if (principal == null) {
            return "redirect:/login-opciones";
        }

        UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
        ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuario.getCodigo());
        
        if (proveedor == null) {
            return "redirect:/menuprincipal?error=acceso_denegado"; 
        }

        model.addAttribute("usuario", usuario);
        model.addAttribute("proveedor", proveedor);
        model.addAttribute("categorias", categoriaService.findAllCustom()); 
        
        return "profesional-detalle"; 
    }
    
	// ----------------------------------------------------
	// PASO A ‚Äî EDITAR EL PERFIL
	// ----------------------------------------------------
	 @GetMapping("/editar")
	 public String mostrarFormularioEdicion(Principal principal, Model model) {
	     if (principal == null) {
	         return "redirect:/login-opciones";
	     }
	
	     UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
	     ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuario.getCodigo());
	
	     if (proveedor == null) {
	         // Redirigir si no es un profesional v√°lido
	         return "redirect:/menuprincipal?error=acceso_denegado"; 
	     }
	     
	     // Rellenar el formulario con datos actuales
	     model.addAttribute("usuario", usuario);
	     model.addAttribute("proveedor", proveedor);
	     
	     // Listas necesarias para los desplegables (distrito, categor√≠as)
	     model.addAttribute("distritos", distritoService.findAllCustom());
	     model.addAttribute("categorias", categoriaService.findAllCustom());
	
	     return "profesional-editar"; // üëà Nueva plantilla para el formulario de edici√≥n
	 }

	// ----------------------------------------------------
	// PASO B ‚Äî GUARDAR EDICI√ìN DEL PERFIL
	// ----------------------------------------------------
	@PostMapping("/guardar-edicion")
	public String guardarEdicion(
	        @ModelAttribute UsuarioEntity usuarioActualizado,
	        @RequestParam Long idDistrito,
	        @RequestParam String experiencia,
	        @RequestParam String descripcion,
	        @RequestParam Long idCategoria,
	        RedirectAttributes redirect,
	        Principal principal) {
	    
	    if (principal == null) {
	        return "redirect:/login-opciones";
	    }
	    
	    // 1. Obtener el usuario original de la BD (se usa el correo del logueado para seguridad)
	    UsuarioEntity usuarioOriginal = usuarioService.findByCorreo(principal.getName());
	    
	    if (usuarioOriginal == null) {
	        return "redirect:/logout"; // Error de sesi√≥n
	    }
	    
	    // 2. Actualizar campos del Usuario (solo los permitidos)
	    usuarioOriginal.setDireccion(usuarioActualizado.getDireccion());
	    usuarioOriginal.setDistrito(distritoService.findById(idDistrito));
	    
	    // 3. Guardar Usuario
	    usuarioService.update(usuarioOriginal, usuarioOriginal.getCodigo());
	    
	    // 4. Obtener el Proveedor asociado y actualizar campos
	    ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuarioOriginal.getCodigo());
	    proveedor.setExperiencia(experiencia);
	    proveedor.setDescripcion(descripcion);
	    proveedor.setCategoria(categoriaService.findById(idCategoria));
	    
	    // 5. Guardar Proveedor
	    proveedorService.update(proveedor, proveedor.getCodigo());

	    redirect.addFlashAttribute("success", "‚úÖ Perfil actualizado correctamente.");
	    return "redirect:/profesional/perfil"; 
	}


	// ----------------------------------------------------
	// PUNTO 1 ‚Äî REGISTRO: Formulario GET (@GetMapping("/registro"))
	// ... (contin√∫an los m√©todos de registro/validaci√≥n existentes)
	 
    @GetMapping("/solicitudes")
    public String solicitudes(Principal principal, Model model){
        
        if (principal == null) {
            return "redirect:/login-opciones";
        }

        UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
        ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuario.getCodigo());
        
        model.addAttribute("usuario", usuario);
        model.addAttribute("proveedor", proveedor);

        model.addAttribute("solicitudes",
               contratacionService.listarPorProveedor(proveedor.getCodigo()));
        
        model.addAttribute("categorias", categoriaService.findAllCustom());
        return "solicitudes-profesional";
    }

    // ====================================================
    // ü•à M√âTODOS DE PERFIL P√öBLICO (CON ID) - VA DESPU√âS
    // ====================================================

    @GetMapping("/{id}")
    public String verPerfilProfesional(@PathVariable Long id, Model model) {

        ProveedorEntity proveedor = proveedorService.findById(id);
        if (proveedor == null) {
            return "redirect:/";
        }

        UsuarioEntity usuario = proveedor.getUsuario();
        Double promedio = resenaService.promedioPorProveedor(id);
        List<ResenaEntity> resenas = resenaService.listarPorProveedor(id);
        
        model.addAttribute("categorias", categoriaService.findAllCustom());

        model.addAttribute("proveedor", proveedor);
        model.addAttribute("usuario", usuario);
        model.addAttribute("promedio", promedio);
        model.addAttribute("resenas", resenas);
        return "profesional-detalle";
    }
    
    // ----------------------------------------------------
    // PUNTO 1 ‚Äî REGISTRO: Formulario GET
    // ----------------------------------------------------
	@GetMapping("/registro")
	public String mostrarFormulario(@ModelAttribute(name = "usuario") UsuarioEntity flashUsuario, Model model) {

		// Si no hay un objeto 'usuario' del FlashAttribute (tras un error), crea uno nuevo.
		if (model.getAttribute("usuario") == null) {
			model.addAttribute("usuario", new UsuarioEntity());
		}

		model.addAttribute("categorias", categoriaService.findAllCustom());
		model.addAttribute("distritos", distritoService.findAllCustom());
		model.addAttribute("tiposdocumento", tipoDocumentoService.findAllCustom());

		return "profesional-registro";
	}
	
	// ----------------------------------------------------
	// PUNTO 2 ‚Äî REGISTRO: Procesar y Validar RENIEC
	// ----------------------------------------------------
	@PostMapping("/nuevoperfil")
	public String procesarRegistro(
			@ModelAttribute UsuarioEntity usuario,
			@RequestParam Long idTipoDocumento,
			@RequestParam Long idDistrito,
			@RequestParam String experiencia,
			@RequestParam String descripcion,
			@RequestParam Long idCategoria,
            @RequestParam("foto") MultipartFile foto, // Recibir la imagen
			HttpSession session,
			RedirectAttributes redirect) {
        
        // ------------------ 1. CONSULTA Y VALIDACI√ìN RENIEC ------------------
        
        // Asume que 1L es DNI y debe tener 8 d√≠gitos
        if (idTipoDocumento != 1L || usuario.getNroDocumento().length() != 8) {
            redirect.addFlashAttribute("errorReniec", "‚ùå El tipo de documento o n√∫mero no es v√°lido para la consulta RENIEC.");
            redirect.addFlashAttribute("usuario", usuario);
            return "redirect:/profesional/registro";
        }

        ReniecEntity datosReniec = reniecService.consultarDni(usuario.getNroDocumento());
        
        // 1.1. Verificar si la consulta API fall√≥
        if (datosReniec == null || datosReniec.getNombres() == null) {
            redirect.addFlashAttribute("errorReniec", "Error al consultar RENIEC. Revise su DNI o intente m√°s tarde.");
            redirect.addFlashAttribute("usuario", usuario);
            return "redirect:/profesional/registro";
        }

        // 1.2. Validar Nombres y Apellidos
        String nombreUsuario = usuario.getNombre().trim();
        String nombreReniec = datosReniec.getNombres().trim();
        
        String apPaternoUsuario = usuario.getApellidoPaterno().trim();
        String apPaternoReniec = datosReniec.getApellidoPaterno().trim();
        
        String apMaternoUsuario = usuario.getApellidoMaterno().trim();
        String apMaternoReniec = datosReniec.getApellidoMaterno().trim();
        
        boolean nombresCoinciden = nombreUsuario.equalsIgnoreCase(nombreReniec);
        boolean apellidoPaternoCoincide = apPaternoUsuario.equalsIgnoreCase(apPaternoReniec);
        boolean apellidoMaternoCoincide = apMaternoUsuario.equalsIgnoreCase(apMaternoReniec);

        if (!(nombresCoinciden && apellidoPaternoCoincide && apellidoMaternoCoincide)) {
            String mensajeError = "‚ùå Los nombres y/o apellidos no coinciden con los datos de RENIEC para el DNI "
                                 + usuario.getNroDocumento() + ". Corrija sus datos.";
            
            redirect.addFlashAttribute("errorReniec", mensajeError);
            redirect.addFlashAttribute("usuario", usuario);
            return "redirect:/profesional/registro";
        }
        
        // ------------------ 2. FLUJO DE VERIFICACI√ìN DE CORREO ------------------
        
		// Convertir los IDs a Entidades (Solo para el objeto temporal)
		usuario.setTipodocumento(tipoDocumentoService.findById(idTipoDocumento));
		usuario.setDistrito(distritoService.findById(idDistrito));
       
        // Guardar TODOS los datos necesarios en sesi√≥n (incluyendo la foto)
		session.setAttribute("usuarioTemp", usuario);
		session.setAttribute("experienciaTemp", experiencia);
		session.setAttribute("descripcionTemp", descripcion);
		session.setAttribute("idCategoriaTemp", idCategoria);
        session.setAttribute("fotoTemp", foto); // Guardar la imagen en sesi√≥n
        
        // Generar y enviar c√≥digo al correo¬†
		String codigo = generarCodigo();
		session.setAttribute("codigoVerificacion", codigo);
		emailService.enviarCorreo(usuario.getCorreo(), "C√≥digo de verificaci√≥n", "Tu c√≥digo es: " + codigo);
		
		session.setAttribute("passwordAction", "/profesional/validar-codigo");
		
		return "verificacion"; // vista para ingresar el c√≥digo¬†
	}
	
	
	// ----------------------------------------------------
	// PUNTO 3 ‚Äî VALIDACI√ìN DE C√ìDIGO
	// ----------------------------------------------------
	private String generarCodigo() {
		return String.valueOf((int)(Math.random() * 900000) + 100000); // 6 d√≠gitos¬†
	}
	
	@PostMapping("/validar-codigo")
	public String validarCodigo(@RequestParam String codigoIngresado, HttpSession session, Model model) {

		String codigoGuardado = (String) session.getAttribute("codigoVerificacion");
		if (codigoGuardado != null && codigoGuardado.equals(codigoIngresado)) {
			session.setAttribute("passwordAction", "/profesional/guardar-perfil-final");
			return "crear-password";
		} else {
			session.setAttribute("passwordAction", "/profesional/validar-codigo");
			model.addAttribute("error", "C√≥digo incorrecto. Intenta nuevamente.");
			return "verificacion";
			}
		}
	
	// ----------------------------------------------------
	// PUNTO 4 ‚Äî GUARDAR PERFIL FINAL (Imagen y Clave)
	// ----------------------------------------------------
	@PostMapping("/guardar-perfil-final")
	public String guardarPerfilFinal( @RequestParam String password, @RequestParam String password2, HttpSession session, RedirectAttributes redirect) {

		if (!password.equals(password2)) {
			redirect.addFlashAttribute("error", "Las contrase√±as no coinciden.");
			return "redirect:/profesional/validar-codigo";
		}

		// 1. Recuperar datos de sesi√≥n
		UsuarioEntity usuario = (UsuarioEntity) session.getAttribute("usuarioTemp");
		MultipartFile foto = (MultipartFile) session.getAttribute("fotoTemp");

		if (usuario == null || foto == null) {
			return "redirect:/profesional/registro?error=sesionperdida";
		}

		String experiencia = (String) session.getAttribute("experienciaTemp");
		String descripcion = (String) session.getAttribute("descripcionTemp");
		Long idCategoria = (Long) session.getAttribute("idCategoriaTemp");
		
		try {
			// 2. Procesar y Guardar Imagen
			String rutaImagen = procesarImagen(foto);
			usuario.setFotoPerfil(rutaImagen);

			// 3. Obtener el rol PROFESIONAL desde la BD
			RolEntity rol = rolService.findByNombre("PROFESIONAL");
			usuario.setRol(rol);
			
			// ‚≠ê ENCRIPTAR LA CLAVE ANTES DE GUARDAR
			usuario.setClave(password);
			usuario.setEstado(true);
			
			// 4. Guardar Usuario
			UsuarioEntity usuarioGuardado = usuarioService.add(usuario);
			
			// 5. Guardar Proveedor
			ProveedorEntity proveedor = new ProveedorEntity();
			proveedor.setUsuario(usuarioGuardado);
			proveedor.setExperiencia(experiencia);
			proveedor.setDescripcion(descripcion);
			proveedor.setCategoria(categoriaService.findById(idCategoria));
			proveedor.setEstado(true);
			proveedorService.add(proveedor);

			// 6. Limpiar sesi√≥n¬†
			session.invalidate();
			
			return "redirect:/login?success=true";
			
		} catch (IOException e) {
			e.printStackTrace();
			// Si falla la imagen, lo devuelve a crear-password para reintentar
			redirect.addFlashAttribute("error", "Error al guardar la foto de perfil. Intente nuevamente.");
			return "redirect:/profesional/validar-codigo";
		} catch (Exception e) {
			e.printStackTrace();
			redirect.addFlashAttribute("error", "Error al guardar el perfil final: " + e.getMessage());
			return "redirect:/profesional/validar-codigo";
			}
		}
    // ----------------------------------------------------
    // M√âTODOS AUXILIARES (Procesamiento de Imagen)
    // ----------------------------------------------------
    private String procesarImagen(MultipartFile archivo) throws IOException {

        if (archivo == null || archivo.isEmpty()) { 
            return "/images/default-profile.png"; // imagen interna por defecto
        }

        // üìÅ Carpeta externa real (IMPORTANTE: DEBE EXISTIR EN SU SISTEMA)
        String carpeta = "C:/arreglago/images/";

        String original = archivo.getOriginalFilename().replace(" ", "_");
        String nombre = System.currentTimeMillis() + "_" + original;

        File destino = new File(carpeta + nombre);
        destino.getParentFile().mkdirs();

        // Redimensionar la imagen y guardarla
        Thumbnails.of(archivo.getInputStream())
                .size(600, 600)
                .keepAspectRatio(true)
                .toFile(destino);

        //¬† URL P√öBLICA (debe mapear el /usuarios/ a la carpeta f√≠sica en su configuraci√≥n de Spring)
        return "/usuarios/" + nombre;
    }
    
    // ====================================================
    // ü•â L√ìGICA DE NEGOCIO CR√çTICA (Contrataci√≥n)
    // ====================================================

    @GetMapping("/contratar/{idProveedor}")
    public String contratarServicio(@PathVariable Long idProveedor,
                                     Principal principal,
                                     Model model) {

        if (principal == null) {
            return "redirect:/login-opciones";
        }

        UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
        ClienteEntity cliente = clienteService.buscarPorUsuario(usuario.getCodigo());
        ProveedorEntity proveedor = proveedorService.findById(idProveedor);

        ContratacionEntity contratacion = new ContratacionEntity();
        contratacion.setCliente(cliente);
        contratacion.setProveedor(proveedor);
        contratacion.setEstado("pendiente");

        contratacionService.add(contratacion);

        // Redirige al cliente a su panel de solicitudes/contrataciones
        return "redirect:/cliente/solicitudes"; 
    }
    


	 @GetMapping("/contratar-form/{idProveedor}")
	 public String mostrarFormularioContratacion(@PathVariable Long idProveedor, Principal principal, Model model) {
	     // Aseguramos que solo un cliente logueado pueda ver este formulario
	     if (principal == null) {
	         return "redirect:/login-opciones";
	     }
	
	     ProveedorEntity proveedor = proveedorService.findById(idProveedor);
	     if (proveedor == null) {
	         return "redirect:/menuprincipal";
	     }
	
	     // Datos del cliente logueado
	     UsuarioEntity clienteUsuario = usuarioService.findByCorreo(principal.getName());
	     
	     model.addAttribute("proveedor", proveedor);
	     model.addAttribute("usuario", proveedor.getUsuario()); // Datos del profesional
	     model.addAttribute("clienteUsuario", clienteUsuario); // Datos del cliente
	     model.addAttribute("categorias", categoriaService.findAllCustom());
	     model.addAttribute("contratacion", new ContratacionEntity()); // Objeto vac√≠o para el formulario
	     
	     return "contratacion-form"; // Nombre de la nueva vista HTML
	 }
	 

	@PostMapping("/confirmar-contratacion/{idProveedor}")
	public String confirmarContratacion(@PathVariable Long idProveedor, 
	                                      @RequestParam String detalle, // Nuevo: Campo detalle
	                                      @RequestParam String fecha,   // Nuevo: Campo fecha
	                                      Principal principal,
	                                      RedirectAttributes redirect) {

	    if (principal == null) {
	        return "redirect:/login-opciones";
	    }
	    
	    // Asumimos que los servicios de Usuario/Cliente est√°n inyectados.
	    UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
	    
	    // 1. Verificar que el usuario logueado sea un cliente
	    if (!usuario.getRol().getNombre().equals("CLIENTE")) {
	        redirect.addFlashAttribute("error", "Solo los clientes pueden contratar servicios.");
	        return "redirect:/menuprincipal";
	    }

	    ClienteEntity cliente = clienteService.buscarPorUsuario(usuario.getCodigo());
	    ProveedorEntity proveedor = proveedorService.findById(idProveedor);
	    
	    if (cliente == null || proveedor == null) {
	        // Fallo en la obtenci√≥n de datos
	        redirect.addFlashAttribute("error", "Error al encontrar el cliente o el proveedor.");
	        return "redirect:/menuprincipal";
	    }

	    // 2. CREACI√ìN Y ASIGNACI√ìN DE LA CONTRATACI√ìN
	    ContratacionEntity contratacion = new ContratacionEntity();
	    contratacion.setCliente(cliente);
	    contratacion.setProveedor(proveedor);
	    contratacion.setDetalleServicio(detalle); // Aseg√∫rate que tu ContratacionEntity tenga este campo
	    // contratacion.setFechaTentativa(convertirFecha(fecha)); // Si tienes un conversor de fechas
	    contratacion.setEstado("pendiente");

	    try {
	        // üö© INTENTAR GUARDAR EL DATO
	        contratacionService.add(contratacion);
	        
	        redirect.addFlashAttribute("success", "‚úÖ Solicitud enviada correctamente.");
	        return "redirect:/cliente/mis-contrataciones";

	    } catch (Exception e) {
	        // üö© CAPTURAR Y MOSTRAR EL ERROR DE BASE DE DATOS
	        e.printStackTrace(); // Muestra el error completo en la consola del servidor
	        redirect.addFlashAttribute("error", "‚ùå Fallo al guardar la solicitud. Error: " + e.getMessage());
	        return "redirect:/profesional/contratar-form/" + idProveedor; // Vuelve al formulario
	    }
	}
}