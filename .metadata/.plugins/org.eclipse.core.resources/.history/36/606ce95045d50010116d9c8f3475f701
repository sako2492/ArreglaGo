package pe.com.arreglago.controller;

import java.io.File;
import java.io.IOException;
import java.math.BigDecimal;
import java.security.Principal;
import java.util.List;
import java.time.LocalDate;
import java.time.temporal.ChronoUnit;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import jakarta.servlet.http.HttpSession;
import net.coobird.thumbnailator.Thumbnails;

import pe.com.arreglago.entity.UsuarioEntity;
import pe.com.arreglago.entity.ProveedorEntity;
import pe.com.arreglago.entity.ReniecEntity;
import pe.com.arreglago.entity.ResenaEntity;
import pe.com.arreglago.entity.RolEntity;
import pe.com.arreglago.entity.SuscripcionEntity;

import pe.com.arreglago.service.UsuarioService;
import pe.com.arreglago.service.ProveedorService;
import pe.com.arreglago.service.ReniecService;
import pe.com.arreglago.service.CategoriaService;
import pe.com.arreglago.service.DistritoService;
import pe.com.arreglago.service.EmailService;
import pe.com.arreglago.service.PaymentService;
import pe.com.arreglago.service.TipoDocumentoService;
import pe.com.arreglago.service.ResenaService;
import pe.com.arreglago.service.RolService;
import pe.com.arreglago.service.SuscripcionService;
import pe.com.arreglago.service.ContratacionService; // Se mantiene si lista solicitudes recibidas

@Controller
@RequestMapping("/profesional")
public class ProfesionalController {

	// ----------------------------------------------------
    // INYECCIONES DE DEPENDENCIAS
    // ----------------------------------------------------
    @Autowired private UsuarioService usuarioService;
    @Autowired private ProveedorService proveedorService;
    @Autowired private CategoriaService categoriaService;
    @Autowired private DistritoService distritoService;
    @Autowired private TipoDocumentoService tipoDocumentoService;
    @Autowired private ResenaService resenaService;
    @Autowired private ContratacionService contratacionService; 
    @Autowired private ReniecService reniecService;
	@Autowired private EmailService emailService;
	@Autowired private RolService rolService;
	@Autowired private PaymentService paymentService;
	@Autowired private SuscripcionService suscripcionService;
    
    // ====================================================
    // ü•á M√âTODOS DE PERFIL PROPIO (AUTENTICADO)
    // ====================================================
    
    @GetMapping("/perfil")
    public String verMiPerfil(Principal principal, Model model) {
        
        if (principal == null) {
            return "redirect:/login";
        }

        UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
        ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuario.getCodigo());
        
        if (proveedor == null) {
            return "redirect:/menuprincipal?error=acceso_denegado"; 
        }

        model.addAttribute("usuario", usuario);
        model.addAttribute("proveedor", proveedor);
        model.addAttribute("categorias", categoriaService.findAllCustom()); 
        
        return "profesional-detalle"; 
        
     // üõë NUEVO: Verificar estado de suscripci√≥n üõë
        boolean estaSuscrito = suscripcionService.existeSuscripcionActiva(proveedor.getCodigo()); // Asume este m√©todo existe
        
        model.addAttribute("usuario", usuario);
        model.addAttribute("proveedor", proveedor);
        model.addAttribute("categorias", categoriaService.findAllCustom()); 
        model.addAttribute("esDueno", principal.getName().equals(usuario.getCorreo())); // Determinar si es due√±o
        model.addAttribute("estaSuscrito", estaSuscrito); // Pasa el estado de suscripci√≥n
        
        // Si est√° suscrito, carga la galer√≠a
        if (estaSuscrito) {
            model.addAttribute("galeria", galeriaProveedorService.listarPorProveedor(proveedor.getCodigo())); // üëà INYECTAR GaleriaProveedorService
        }
        
        return "profesional-detalle";
    }
    
	// ----------------------------------------------------
	// PASO A ‚Äî EDITAR EL PERFIL
	// ----------------------------------------------------
	 @GetMapping("/editar")
	 public String mostrarFormularioEdicion(Principal principal, Model model) {
		 if (principal == null) {
			 return "redirect:/login";
		 }
	
		 UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
		 ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuario.getCodigo());
	
		 if (proveedor == null) {
			 return "redirect:/menuprincipal?error=acceso_denegado";
		 }

		 model.addAttribute("usuario", usuario);
		 model.addAttribute("proveedor", proveedor);
		 model.addAttribute("distritos", distritoService.findAllCustom());
		 model.addAttribute("categorias", categoriaService.findAllCustom());
	
		 return "profesional-editar"; 
	 }

	// ----------------------------------------------------
	// PASO B ‚Äî GUARDAR EDICI√ìN DEL PERFIL
	// ----------------------------------------------------
	@PostMapping("/guardar-edicion")
	public String guardarEdicion(
			@ModelAttribute UsuarioEntity usuarioActualizado,
			@RequestParam Long idDistrito,
			@RequestParam String experiencia,
			@RequestParam String descripcion,
			@RequestParam Long idCategoria,
			RedirectAttributes redirect,
			Principal principal) {
		
		if (principal == null) {
			return "redirect:/login";
		}
		
		UsuarioEntity usuarioOriginal = usuarioService.findByCorreo(principal.getName());

		if (usuarioOriginal == null) {
			return "redirect:/logout"; 
		}

		// 2. Actualizar campos del Usuario (solo los permitidos)
		usuarioOriginal.setDireccion(usuarioActualizado.getDireccion());
		usuarioOriginal.setDistrito(distritoService.findById(idDistrito));
		
		// 3. Guardar Usuario (M√©todo update requiere el ID)
		usuarioService.update(usuarioOriginal, usuarioOriginal.getCodigo()); 
		
		// 4. Obtener el Proveedor asociado y actualizar campos
		ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuarioOriginal.getCodigo());
		proveedor.setExperiencia(experiencia);
		proveedor.setDescripcion(descripcion);
		proveedor.setCategoria(categoriaService.findById(idCategoria));
		
		// 5. Guardar Proveedor
		proveedorService.update(proveedor, proveedor.getCodigo());

		redirect.addFlashAttribute("success", "‚úÖ Perfil actualizado correctamente.");
		return "redirect:/profesional/perfil";
	}

    // ----------------------------------------------------
	// SOLICITUDES RECIBIDAS (Contrataciones de clientes)
	// ----------------------------------------------------
    @GetMapping("/solicitudes")
    public String solicitudes(Principal principal, Model model){
        
        if (principal == null) {
            return "redirect:/login";
        }

        UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
        ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuario.getCodigo());
        
        model.addAttribute("usuario", usuario);
        model.addAttribute("proveedor", proveedor);

        model.addAttribute("solicitudes",
            contratacionService.listarPorProveedor(proveedor.getCodigo()));
        
        model.addAttribute("categorias", categoriaService.findAllCustom());
        return "solicitudes-profesional";
    }

     // ----------------------------------------------------
     // ACCI√ìN: CAMBIAR ESTADO DE CONTRATACI√ìN (Aceptado, Rechazado)
     // ----------------------------------------------------
     @GetMapping("/solicitudes/estado/{idContratacion}/{estado}") // üëà Nueva URL m√°s expl√≠cita
     public String cambiarEstadoContratacion(@PathVariable("idContratacion") Long idContratacion,
                                             @PathVariable("estado") String estado,
                                             RedirectAttributes redirect){
         try {
             contratacionService.cambiarEstado(idContratacion, estado);
             redirect.addFlashAttribute("success", "El estado de la solicitud ha cambiado a: " + estado.toUpperCase());
         } catch (Exception e) {
             redirect.addFlashAttribute("error", "Error al actualizar el estado: " + e.getMessage());
         }
         return "redirect:/profesional/solicitudes"; // Siempre redirige al listado
     }

    // ====================================================
    // ü•à M√âTODOS DE PERFIL P√öBLICO (CON ID)
    // ====================================================

    @GetMapping("/{id}")
    public String verPerfilProfesional(@PathVariable Long id, Model model) {

        ProveedorEntity proveedor = proveedorService.findById(id);
        if (proveedor == null) {
            return "redirect:/";
        }

        UsuarioEntity usuario = proveedor.getUsuario();
        Double promedio = resenaService.promedioPorProveedor(id);
        List<ResenaEntity> resenas = resenaService.listarPorProveedor(id);
        
        model.addAttribute("categorias", categoriaService.findAllCustom());

        model.addAttribute("proveedor", proveedor);
        model.addAttribute("usuario", usuario);
        model.addAttribute("promedio", promedio);
        model.addAttribute("resenas", resenas);
        return "profesional-detalle";
    }
    
    // ====================================================
    // ü•â FLUJO DE REGISTRO
    // ====================================================

    // ----------------------------------------------------
    // PUNTO 1 ‚Äî REGISTRO: Formulario GET
    // ----------------------------------------------------
	@GetMapping("/registro")
	public String mostrarFormulario(@ModelAttribute(name = "usuario") UsuarioEntity flashUsuario, Model model) {

		// Si hay dos m√©todos GetMapping("/registro"), Spring solo usa el √∫ltimo definido
        // He unificado este m√©todo ya que solo estaba al final de tu c√≥digo.
		if (model.getAttribute("usuario") == null) {
			model.addAttribute("usuario", new UsuarioEntity());
		}

		model.addAttribute("categorias", categoriaService.findAllCustom());
		model.addAttribute("distritos", distritoService.findAllCustom());
		model.addAttribute("tiposdocumento", tipoDocumentoService.findAllCustom());

		return "profesional-registro";
	}
	
	// ----------------------------------------------------
	// PUNTO 2 ‚Äî REGISTRO: Procesar y Validar RENIEC
	// ----------------------------------------------------
	@PostMapping("/nuevoperfil")
	public String procesarRegistro(
			@ModelAttribute UsuarioEntity usuario,
			@RequestParam Long idTipoDocumento,
			@RequestParam Long idDistrito,
			@RequestParam String experiencia,
			@RequestParam String descripcion,
			@RequestParam Long idCategoria,
            @RequestParam("foto") MultipartFile foto,
			HttpSession session,
			RedirectAttributes redirect) {
		
		// VALIDACI√ìN A: CORREO DUPLICADO
	    if (usuarioService.findByCorreo(usuario.getCorreo()) != null) {
	        redirect.addFlashAttribute("errorReniec", "‚ùå Este correo electr√≥nico ya se encuentra registrado. Por favor, usa uno diferente.");
	        redirect.addFlashAttribute("usuario", usuario);
	        return "redirect:/profesional/registro";
	    }
	    
	    // VALIDACI√ìN B: üõë DNI DUPLICADO (NUEVA L√ìGICA) üõë
	    if (usuarioService.findByNroDocumento(usuario.getNroDocumento()) != null) {
	        redirect.addFlashAttribute("errorReniec", "‚ùå El DNI " + usuario.getNroDocumento() + " ya est√° asociado a una cuenta existente.");
	        redirect.addFlashAttribute("usuario", usuario);
	        return "redirect:/profesional/registro";
	    }
	    
	    // üõë NUEVA VALIDACI√ìN: MAYOR DE 18 A√ëOS üõë
	    LocalDate fechaNacimiento = usuario.getFechaNacimiento(); // Asume que este campo existe en UsuarioEntity
	    LocalDate hoy = LocalDate.now();

	    // Calcula la edad en a√±os
	    long edad = ChronoUnit.YEARS.between(fechaNacimiento, hoy);

	    if (edad < 18) {
	        redirect.addFlashAttribute("errorReniec", "‚ùå Debes ser mayor de 18 a√±os para registrarte como profesional.");
	        redirect.addFlashAttribute("usuario", usuario); // Para repoblar el formulario
	        return "redirect:/profesional/registro";
	    }
        
        // --- 1. CONSULTA Y VALIDACI√ìN RENIEC ---
        if (idTipoDocumento != 1L || usuario.getNroDocumento().length() != 8) {
            redirect.addFlashAttribute("errorReniec", "‚ùå El tipo de documento o n√∫mero no es v√°lido para la consulta RENIEC.");
            redirect.addFlashAttribute("usuario", usuario);
            return "redirect:/profesional/registro";
        }

        ReniecEntity datosReniec = reniecService.consultarDni(usuario.getNroDocumento());
        
        if (datosReniec == null || datosReniec.getNombres() == null) {
            redirect.addFlashAttribute("errorReniec", "Error al consultar RENIEC. Revise su DNI o intente m√°s tarde.");
            redirect.addFlashAttribute("usuario", usuario);
            return "redirect:/profesional/registro";
        }

        String nombreUsuario = usuario.getNombre().trim();
        String nombreReniec = datosReniec.getNombres().trim();
        String apPaternoUsuario = usuario.getApellidoPaterno().trim();
        String apPaternoReniec = datosReniec.getApellidoPaterno().trim();
        String apMaternoUsuario = usuario.getApellidoMaterno().trim();
        String apMaternoReniec = datosReniec.getApellidoMaterno().trim();
        
        boolean nombresCoinciden = nombreUsuario.equalsIgnoreCase(nombreReniec);
        boolean apellidoPaternoCoincide = apPaternoUsuario.equalsIgnoreCase(apPaternoReniec);
        boolean apellidoMaternoCoincide = apMaternoUsuario.equalsIgnoreCase(apMaternoReniec);

        if (!(nombresCoinciden && apellidoPaternoCoincide && apellidoMaternoCoincide)) {
            String mensajeError = "‚ùå Los nombres y/o apellidos no coinciden con los datos de RENIEC para el DNI "
                                    + usuario.getNroDocumento() + ". Corrija sus datos.";
            
            redirect.addFlashAttribute("errorReniec", mensajeError);
            redirect.addFlashAttribute("usuario", usuario);
            return "redirect:/profesional/registro";
        }
        
        // --- 2. FLUJO DE VERIFICACI√ìN DE CORREO ---
        usuario.setTipodocumento(tipoDocumentoService.findById(idTipoDocumento));
        usuario.setDistrito(distritoService.findById(idDistrito));
        
        // Guardar TODOS los datos necesarios en sesi√≥n
        session.setAttribute("usuarioTemp", usuario);
        session.setAttribute("experienciaTemp", experiencia);
        session.setAttribute("descripcionTemp", descripcion);
        session.setAttribute("idCategoriaTemp", idCategoria);
        session.setAttribute("fotoTemp", foto); 
        
        // Generar y enviar c√≥digo al correo 
        String codigo = generarCodigo();
        session.setAttribute("codigoVerificacion", codigo);
        emailService.enviarCorreo(usuario.getCorreo(), "C√≥digo de verificaci√≥n", "Tu c√≥digo es: " + codigo);
        
        session.setAttribute("passwordAction", "/profesional/validar-codigo");
        
        return "verificacion"; // vista para ingresar el c√≥digo 
	}
	
	
	// ----------------------------------------------------
	// PUNTO 3 ‚Äî VALIDACI√ìN DE C√ìDIGO
	// ----------------------------------------------------
	private String generarCodigo() {
		return String.valueOf((int)(Math.random() * 900000) + 100000); // 6 d√≠gitos 
	}
	
    // NOTA: EL ERROR DE SINTAXIS ESTABA AQU√ç (Faltaba una llave)
	@PostMapping("/validar-codigo")
	public String validarCodigo(@RequestParam String codigoIngresado, HttpSession session, Model model) {

		String codigoGuardado = (String) session.getAttribute("codigoVerificacion");
		if (codigoGuardado != null && codigoGuardado.equals(codigoIngresado)) {
			session.setAttribute("passwordAction", "/profesional/guardar-perfil-final");
			return "crear-password";
		} else {
			session.setAttribute("passwordAction", "/profesional/validar-codigo");
			model.addAttribute("error", "C√≥digo incorrecto. Intenta nuevamente.");
			return "verificacion";
		} // ‚úÖ Llave faltante agregada
	}
	
	// ----------------------------------------------------
	// PUNTO 4 ‚Äî GUARDAR PERFIL FINAL (Imagen y Clave)
	// ----------------------------------------------------
	@PostMapping("/guardar-perfil-final")
	public String guardarPerfilFinal( @RequestParam String password, @RequestParam String password2, HttpSession session, RedirectAttributes redirect) {

		if (!password.equals(password2)) {
			redirect.addFlashAttribute("error", "Las contrase√±as no coinciden.");
			return "redirect:/profesional/validar-codigo";
		}

		// 1. Recuperar datos de sesi√≥n
		UsuarioEntity usuario = (UsuarioEntity) session.getAttribute("usuarioTemp");
		MultipartFile foto = (MultipartFile) session.getAttribute("fotoTemp");

		if (usuario == null || foto == null) {
			return "redirect:/profesional/registro?error=sesionperdida";
		}

		String experiencia = (String) session.getAttribute("experienciaTemp");
		String descripcion = (String) session.getAttribute("descripcionTemp");
		Long idCategoria = (Long) session.getAttribute("idCategoriaTemp");
		
		try {
			// 2. Procesar y Guardar Imagen
			String rutaImagen = procesarImagen(foto);
			usuario.setFotoPerfil(rutaImagen);

			// 3. Obtener el rol PROFESIONAL desde la BD
			RolEntity rol = rolService.findByNombre("PROFESIONAL");
			usuario.setRol(rol);
			
			// ‚≠ê ENCRIPTAR LA CLAVE ANTES DE GUARDAR (Nota: Asumo que esto se maneja con Spring Security o un servicio de encriptaci√≥n)
			usuario.setClave(password);
			usuario.setEstado(true);
			
			// 4. Guardar Usuario
			UsuarioEntity usuarioGuardado = usuarioService.add(usuario);
			
			// 5. Guardar Proveedor
			ProveedorEntity proveedor = new ProveedorEntity();
			proveedor.setUsuario(usuarioGuardado);
			proveedor.setExperiencia(experiencia);
			proveedor.setDescripcion(descripcion);
			proveedor.setCategoria(categoriaService.findById(idCategoria));
			proveedor.setEstado(true);
			proveedorService.add(proveedor);

			// 6. Limpiar sesi√≥n 
			session.invalidate();
			
			return "redirect:/login?success=true";
			
		} catch (IOException e) {
			e.printStackTrace();
			// Si falla la imagen, lo devuelve a crear-password para reintentar
			redirect.addFlashAttribute("error", "Error al guardar la foto de perfil. Intente nuevamente.");
			return "redirect:/profesional/validar-codigo";
		} catch (Exception e) {
			e.printStackTrace();
			redirect.addFlashAttribute("error", "Error al guardar el perfil final: " + e.getMessage());
			return "redirect:/profesional/validar-codigo";
		} // ‚úÖ Llave faltante agregada
	}
    // ----------------------------------------------------
    // M√âTODOS AUXILIARES (Procesamiento de Imagen)
    // ----------------------------------------------------
    private String procesarImagen(MultipartFile archivo) throws IOException {

        if (archivo == null || archivo.isEmpty()) { 
            return "/images/default-profile.png"; // imagen interna por defecto
        }

        // üìÅ Carpeta externa real (IMPORTANTE: DEBE EXISTIR EN SU SISTEMA)
        String carpeta = "C:/arreglago/images/";

        String original = archivo.getOriginalFilename().replace(" ", "_");
        String nombre = System.currentTimeMillis() + "_" + original;

        File destino = new File(carpeta + nombre);
        destino.getParentFile().mkdirs();

        // Redimensionar la imagen y guardarla
        Thumbnails.of(archivo.getInputStream())
                .size(600, 600)
                .keepAspectRatio(true)
                .toFile(destino);

        //  URL P√öBLICA (debe mapear el /usuarios/ a la carpeta f√≠sica en su configuraci√≥n de Spring)
        return "/usuarios/" + nombre;
    }
    
    @PostMapping("/suscripcion/comprar")
    public String comprarSuscripcion(@RequestParam("monto") BigDecimal monto,
    								@RequestParam("tokenPago") String tokenPago,
    								@RequestParam("metodoPago") String metodoPago,
                                     Principal principal, // Necesitas el principal para obtener el ID real
                                     RedirectAttributes redirect) {
    	
    	// üõë Obtener el ID del proveedor logueado üõë
        UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
        ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuario.getCodigo());
        Long idProveedorLogueado = proveedor.getCodigo(); // Usar el ID real del proveedor
        
        // 1. SIMULAR EL PROCESAMIENTO DE PAGO CON STRIPE
        boolean pagoExitoso = paymentService.processSubscriptionPayment(tokenPago, monto, idProveedorLogueado.intValue());

        if (pagoExitoso) {
            try {
                // 2. REGISTRAR LA SUSCRIPCI√ìN EN LA BASE DE DATOS
                SuscripcionEntity suscripcion = suscripcionService.registrarSuscripcionExitosa(
                    idProveedorLogueado.intValue(), monto, metodoPago
                );
                
                // 3. üü¢ REDIRECCI√ìN A P√ÅGINA DE √âXITO üü¢
                redirect.addFlashAttribute("success", "‚úÖ ¬°Pago y Suscripci√≥n Activada con √âxito!");
                redirect.addFlashAttribute("fechaFin", suscripcion.getFechaFin());
                redirect.addFlashAttribute("idProveedor", idProveedorLogueado);
                
                return "redirect:/profesional/pago-exitoso"; // Nuevo endpoint
                
            } catch (Exception e) {
                System.err.println("Error al registrar suscripci√≥n: " + e.getMessage());
                redirect.addFlashAttribute("error", "Pago OK, pero fall√≥ el registro de la suscripci√≥n.");
                return "redirect:/profesional/suscripcion/comprar"; 
            }
        } else {
            // PAGO FALLIDO
            redirect.addFlashAttribute("error", "‚ùå El pago ha sido rechazado o el monto es insuficiente.");
            return "redirect:/profesional/suscripcion/comprar"; 
        }
    }
    
 // ====================================================
 // üèÖ FLUJO DE SUSCRIPCI√ìN Y PAGO
 // ====================================================

 @GetMapping("/suscripcion/comprar")
 public String mostrarFormularioSuscripcion(Principal principal, Model model) {
     if (principal == null) {
         return "redirect:/login";
     }

     // Obtener proveedor logueado
     UsuarioEntity usuario = usuarioService.findByCorreo(principal.getName());
     ProveedorEntity proveedor = proveedorService.buscarPorUsuario(usuario.getCodigo());

     if (proveedor == null) {
         return "redirect:/menuprincipal"; // Solo proveedores pueden suscribirse
     }

     // Datos que se mostrar√°n en la vista
     model.addAttribute("proveedor", proveedor);
     model.addAttribute("montoSuscripcion", new BigDecimal("150.00")); // Monto fijo
     model.addAttribute("categorias", categoriaService.findAllCustom());
     
     // Aqu√≠ puedes incluir datos de suscripci√≥n actual si existe

     return "suscripcion-pago"; 
 }
 
	//----------------------------------------------------
	//üõë NUEVO ENDPOINT: P√ÅGINA DE √âXITO DE PAGO üõë
	//----------------------------------------------------
	
	@GetMapping("/pago-exitoso")
	public String pagoExitoso(Model model) {
	  // Si no hay atributos flash, redirige al perfil
	  if (!model.containsAttribute("idProveedor")) {
	      return "redirect:/profesional/perfil"; 
	  }
	  // Si s√≠ hay atributos, muestra la p√°gina estilizada
	  return "pago-exitoso";
	}
	
	// ProfesionalController.java

	// ... (dentro de la clase) ...

	// ----------------------------------------------------
	// üõë NUEVO ENDPOINT: GESTI√ìN DE GALER√çA DE FOTOS üõë
	// ----------------------------------------------------
	@GetMapping("/galeria/{id}")
	public String gestionarGaleria(@PathVariable Long id, Principal principal, Model model) {
	    
	    // 1. Verificaci√≥n de Seguridad: Solo el due√±o puede editar su propia galer√≠a
	    UsuarioEntity usuarioLogueado = usuarioService.findByCorreo(principal.getName());
	    ProveedorEntity proveedor = proveedorService.findById(id);

	    if (proveedor == null || !proveedor.getUsuario().getCodigo().equals(usuarioLogueado.getCodigo())) {
	    	return "redirect:/profesional/perfil?error=acceso_no_autorizado";
	        }
	    
	    // 2. Cargar datos de la galer√≠a existente (En proceso)
	    // model.addAttribute("imagenes", galeriaService.listarPorProveedor(id));
	    model.addAttribute("proveedor", proveedor);
	    model.addAttribute("categorias", categoriaService.findAllCustom());

	    return "galeria-profesional"; // La vista donde subir√° las fotos
	}
}