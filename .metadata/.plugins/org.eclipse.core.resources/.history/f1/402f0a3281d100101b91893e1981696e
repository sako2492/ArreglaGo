package pe.com.arreglago.webconfig;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

import pe.com.arreglago.security.CustomSuccessHandler;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private UserDetailsService usuarioDetailsService;

    @Autowired
    private CustomSuccessHandler customSuccessHandler;

    // 1. BEAN PARA ENCRIPTAR CONTRASE칌AS
    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    // 2. BEAN PARA VINCULAR EL SERVICIO DE USUARIOS Y LA ENCRIPTACI칍N
    // (Esto es lo que te faltaba para que el login verifique bien la clave)
    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        authProvider.setUserDetailsService(usuarioDetailsService);
        authProvider.setPasswordEncoder(passwordEncoder());
        return authProvider;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http.authorizeHttpRequests(auth -> auth
            // =======================================================
            // 游댑 ZONA P칔BLICA (Cualquiera puede entrar)
            // =======================================================
            // 1. Recursos est치ticos (CSS, JS, Im치genes)
            .requestMatchers("/css/**", "/js/**", "/images/**", "/webjars/**").permitAll()

            // 2. Vistas generales y Login
            .requestMatchers("/", "/index", "/menuprincipal", "/login-opciones", "/login", "/buscar").permitAll()
            .requestMatchers("/categoria/**").permitAll() // Para ver categor칤as sin loguearse

            // 3. Formularios de Registro (Solo las URLs espec칤ficas, NO todo el /**)
            .requestMatchers("/profesional/registro", "/profesional/nuevoperfil").permitAll()
            .requestMatchers("/cliente/registro", "/cliente/nuevoperfil").permitAll()
            .requestMatchers("/administrador/registro").permitAll()

            // 4. Flujos de verificaci칩n (C칩digos de correo y contrase침a)
            .requestMatchers("/profesional/validar-codigo", "/profesional/guardar-perfil-final").permitAll()
            .requestMatchers("/cliente/validar-codigo", "/cliente/guardar-perfil-final").permitAll()

            // 5. APIs p칰blicas (Ej: Consulta RENIEC)
            .requestMatchers("/api/**").permitAll()

            // =======================================================
            // 游 ZONA PRIVADA (Requiere Login y Rol espec칤fico)
            // =======================================================
            // El orden importa: Primero las p칰blicas arriba, y aqu칤 bloqueamos el resto
            .requestMatchers("/cliente/**").hasRole("CLIENTE")
            .requestMatchers("/profesional/**").hasRole("PROFESIONAL") // Aqu칤 entra perfil, solicitudes, etc.
            .requestMatchers("/admin/**").hasRole("ADMINISTRADOR")     // O "ADMIN" seg칰n tu BD

            // Cualquier otra cosa requiere estar logueado
            .anyRequest().authenticated()
        )

        .formLogin(login -> login
            .loginPage("/index")            // Tu p치gina de login (que es el index/modal)
            .loginProcessingUrl("/login")   // Url interna de Spring Security para procesar
            .usernameParameter("username")  // name="username" en tu HTML
            .passwordParameter("password")  // name="password" en tu HTML
            .successHandler(customSuccessHandler) // Redirecci칩n inteligente por rol
            .failureUrl("/index?error=true") // Si falla, vuelve al index con error
            .permitAll()
        )

        .logout(logout -> logout
            .logoutUrl("/logout")
            .logoutSuccessUrl("/index?logout=true")
            .deleteCookies("JSESSIONID")
            .permitAll()
        )

        .csrf(csrf -> csrf.disable()); // Deshabilitado para desarrollo

        return http.build();
    }
}