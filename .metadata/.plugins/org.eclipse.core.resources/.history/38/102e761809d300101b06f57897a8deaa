package pe.com.arreglago.controller;

import java.security.Principal;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import pe.com.arreglago.entity.UsuarioEntity;
import pe.com.arreglago.entity.CategoriaEntity;
import pe.com.arreglago.service.UsuarioService;
import pe.com.arreglago.service.CategoriaService;
import pe.com.arreglago.service.ProveedorService;
import pe.com.arreglago.service.ClienteService;
// Importa el servicio de auditor√≠a si lo tienes
// import pe.com.arreglago.service.AuditoriaService; 

@Controller
@RequestMapping("/admin")
public class AdminController {

    @Autowired private UsuarioService usuarioService;
    @Autowired private CategoriaService categoriaService;
    @Autowired private ProveedorService proveedorService;
    @Autowired private ClienteService clienteService;
    // @Autowired private AuditoriaService auditoriaService; // Para la tabla de auditor√≠a

    /**
     * Muestra el panel principal de administraci√≥n.
     */
    @GetMapping("/dashboard")
    public String adminDashboard(Principal principal, Model model) {
        // Obtener usuario logueado
        UsuarioEntity adminUsuario = usuarioService.findByCorreo(principal.getName());

        // 1. Gesti√≥n de Categor√≠as
        model.addAttribute("categorias", categoriaService.findAll());
        model.addAttribute("nuevaCategoria", new CategoriaEntity());

        // 2. Validaci√≥n de Cuentas (Asumiendo un m√©todo para buscar proveedores pendientes)
        // model.addAttribute("proveedoresPendientes", proveedorService.findProveedoresPendientes());

        // 3. Clientes (Bloqueo/Desbloqueo)
        // model.addAttribute("clientes", clienteService.findAll());

        // 4. Auditor√≠a (Asumiendo un m√©todo para obtener registros de auditor√≠a)
        // model.addAttribute("registrosAuditoria", auditoriaService.findRecentLogs());

        model.addAttribute("adminUsuario", adminUsuario);
        return "admin-dashboard"; 
    }

    /* ====================================================
     * GESTI√ìN DE CATEGOR√çAS
     * ==================================================== */

    @PostMapping("/categorias/agregar")
    public String agregarCategoria(CategoriaEntity nuevaCategoria, RedirectAttributes redirect) {
        try {
            categoriaService.add(nuevaCategoria);
            redirect.addFlashAttribute("success", "‚úÖ Categor√≠a '" + nuevaCategoria.getNombre() + "' agregada con √©xito.");
        } catch (Exception e) {
            redirect.addFlashAttribute("error", "‚ùå Error al agregar categor√≠a: " + e.getMessage());
        }
        return "redirect:/admin/dashboard";
    }

    @PostMapping("/categorias/eliminar")
    public String eliminarCategoria(@RequestParam Long idCategoria, RedirectAttributes redirect) {
        try {
            categoriaService.delete(idCategoria);
            redirect.addFlashAttribute("success", "‚úÖ Categor√≠a eliminada con √©xito.");
        } catch (Exception e) {
            redirect.addFlashAttribute("error", "‚ùå Error al eliminar categor√≠a. Aseg√∫rate de que no tenga proveedores asociados.");
        }
        return "redirect:/admin/dashboard";
    }

    /* ====================================================
     * VALIDACI√ìN DE PROVEEDORES
     * (Necesitas m√©todos similares para aceptar o rechazar)
     * ==================================================== */
    
    @PostMapping("/proveedor/validar")
    public String validarProveedor(@RequestParam Long idProveedor, RedirectAttributes redirect) {
        // L√≥gica: proveedorService.validate(idProveedor);
        redirect.addFlashAttribute("success", "‚úÖ Proveedor validado y activado.");
        return "redirect:/admin/dashboard";
    }

    /* ====================================================
     * BLOQUEO DE CLIENTES
     * (Necesitas la l√≥gica en ClienteService para cambiar el estado)
     * ==================================================== */
     
    @PostMapping("/cliente/bloquear")
    public String bloquearCliente(@RequestParam Long idCliente, RedirectAttributes redirect) {
        // L√≥gica: clienteService.block(idCliente);
        redirect.addFlashAttribute("success", "üîí Cliente bloqueado por reputaci√≥n.");
        return "redirect:/admin/dashboard";
    }

}