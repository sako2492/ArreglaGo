package pe.com.arreglago.controller;

import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

import pe.com.arreglago.entity.UsuarioEntity;
import pe.com.arreglago.entity.ProveedorEntity;
import pe.com.arreglago.entity.RolEntity;
import pe.com.arreglago.entity.DistritoEntity;
import pe.com.arreglago.entity.TipoDocumentoEntity;
import pe.com.arreglago.entity.CategoriaEntity;
import pe.com.arreglago.service.UsuarioService;
import pe.com.arreglago.service.ProveedorService;
import pe.com.arreglago.service.CategoriaService;
import pe.com.arreglago.service.DistritoService;
import pe.com.arreglago.service.TipoDocumentoService;

@Controller
public class ProfesionalController {

    @Autowired
    private UsuarioService usuarioService;

    @Autowired
    private ProveedorService proveedorService;

    @Autowired
    private CategoriaService categoriaService;

    @Autowired
    private DistritoService distritoService;

    @Autowired
    private TipoDocumentoService tipoDocumentoService;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @GetMapping("/profesional/registro")
    public String mostrarFormulario(Model model) {
        model.addAttribute("usuario", new UsuarioEntity());
        model.addAttribute("categorias", categoriaService.findAllCustom());
        model.addAttribute("distritos", distritoService.findAllCustom());
        model.addAttribute("tiposdocumento", tipoDocumentoService.findAllCustom());
        return "profesional-registro";
    }

    @PostMapping("/profesional/registro")
    public String registrarProfesional(
            @ModelAttribute UsuarioEntity usuario,
            @RequestParam String experiencia,
            @RequestParam String descripcion,
            @RequestParam Long idCategoria,
    		@RequestParam("foto") MultipartFile foto,
    		Model model){
    	try {
        // IDs de relaciones enviados desde el form
        Long idDistrito = usuario.getDistrito().getCodigo();
        Long idTipoDoc = usuario.getTipodocumento().getCodigo();

        DistritoEntity distrito = distritoService.findById(idDistrito);
        TipoDocumentoEntity tipoDocumento = tipoDocumentoService.findById(idTipoDoc);
        CategoriaEntity categoria = categoriaService.findById(idCategoria);

        usuario.setDistrito(distrito);
        usuario.setTipodocumento(tipoDocumento);

        // Rol PROFESIONAL (ajusta ID seg√∫n tu tabla)
        RolEntity rol = new RolEntity();
        rol.setCodigo(3L);
        usuario.setRol(rol);

        usuario.setEstado(true);
        usuario.setClave(passwordEncoder.encode(usuario.getClave()));
        
     // 2. Guardar foto si existe
        if (!foto.isEmpty()) {

            String nombreArchivo = System.currentTimeMillis() + "_" + foto.getOriginalFilename();

            // Ruta dentro de static/images
            Path ruta = Paths.get("src/main/resources/static/images/" + nombreArchivo);

            Files.write(ruta, foto.getBytes());

            // Guardamos ruta que Thymeleaf puede mostrar
            usuario.setFotoPerfil("/images/" + nombreArchivo);
        }

        UsuarioEntity nuevoUsuario = usuarioService.add(usuario);

        // Crear proveedor
        ProveedorEntity proveedor = new ProveedorEntity();
        proveedor.setUsuario(nuevoUsuario);
        proveedor.setCategoria(categoria);
        proveedor.setDescripcion(descripcion);
        proveedor.setExperiencia(experiencia);
        proveedor.setEstado(true);

        proveedorService.add(proveedor);

        return "redirect:/login-opciones";
        
    } catch (Exception e) {
        e.printStackTrace();
        model.addAttribute("error", "Error al registrar profesional");
        return "profesional-registro";
    }
  }
}
